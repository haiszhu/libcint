function f = cgto2func_uracil_dimer_aug_ccpvdz(x,y,z)
% implement cgto, which calls libcint, libcgto, np_helper, etc...
% phi_k * phi_l, totoal Norb^2, we store about half of it
% 
%
% uracil_dimer, aug_ccpvdz
% geom='''
%     O    -1.4663316    1.0121693    0.0000000
%     C    -0.6281464    1.9142678    0.0000000
%     N     0.7205093    1.6882688    0.0000000
%     C     1.6367290    2.7052764    0.0000000
%     C     1.2769036    4.0061763    0.0000000
%     C    -0.1286005    4.3621549    0.0000000
%     N    -0.9777230    3.2396433    0.0000000
%     O    -0.5972229    5.4864066    0.0000000
%     H     2.0103504    4.7938642    0.0000000
%     H     1.0232515    0.7061820    0.0000000
%     H    -1.9700268    3.4323850    0.0000000
%     H     2.6690620    2.3883417    0.0000000
%     O     1.4663316   -1.0121693    0.0000000
%     C     0.6281464   -1.9142678    0.0000000
%     N    -0.7205093   -1.6882688    0.0000000
%     C    -1.6367290   -2.7052764    0.0000000
%     C    -1.2769036   -4.0061763    0.0000000
%     C     0.1286005   -4.3621549    0.0000000
%     N     0.9777230   -3.2396433    0.0000000
%     O     0.5972229   -5.4864066    0.0000000
%     H    -2.0103504   -4.7938642    0.0000000
%     H    -1.0232515   -0.7061820    0.0000000
%     H     1.9700268   -3.4323850    0.0000000
%     H    -2.6690620   -2.3883417    0.0000000
%     '''
% 
% mol_uracil_dimer = gto.M(
%         verbose=7, 
%         atom=geom, 
%         basis='aug-ccpvdz')
%
% use parameters from pyscf/pyscf/gto/eval_gto.py
% 
%
% 01/23/25 Hai

% respect the shape of input variables
Norb = 440;
nd = Norb*(Norb+1)/2;
[n1,n2,n3] = size(x);
f = zeros([n1 n2 n3 nd]); % need to be changed later

persistent ngrids shls_slice ao_loc non0tab atm bas env natm nbas nao triuidx triflag;
if isempty(ngrids)
  % ngrids = 1; 
  shls_slice = [0, 168];
  ao_loc = [ 
     0,   2,   3,   4,   7,  10,  13,  18,  23,  25,  26,  27,  30, ...
    33,  36,  41,  46,  48,  49,  50,  53,  56,  59,  64,  69,  71, ...
    72,  73,  76,  79,  82,  87,  92,  94,  95,  96,  99, 102, 105, ...
   110, 115, 117, 118, 119, 122, 125, 128, 133, 138, 140, 141, 142, ...
   145, 148, 151, 156, 161, 163, 164, 165, 168, 171, 174, 179, 184, ...
   185, 186, 187, 190, 193, 194, 195, 196, 199, 202, 203, 204, 205, ...
   208, 211, 212, 213, 214, 217, 220, 222, 223, 224, 227, 230, 233, ...
   238, 243, 245, 246, 247, 250, 253, 256, 261, 266, 268, 269, 270, ...
   273, 276, 279, 284, 289, 291, 292, 293, 296, 299, 302, 307, 312, ...
   314, 315, 316, 319, 322, 325, 330, 335, 337, 338, 339, 342, 345, ...
   348, 353, 358, 360, 361, 362, 365, 368, 371, 376, 381, 383, 384, ...
   385, 388, 391, 394, 399, 404, 405, 406, 407, 410, 413, 414, 415, ...
   416, 419, 422, 423, 424, 425, 428, 431, 432, 433, 434, 437, 440];
  non0tab = [
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, ...
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, ...
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, ...
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, ...
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, ...
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, ...
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, ...
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1];
  atm = [
    8,  20,   1,  23,   0,   0,...
    6,  24,   1,  27,   0,   0,...
    7,  28,   1,  31,   0,   0,...
    6,  32,   1,  35,   0,   0,...
    6,  36,   1,  39,   0,   0,...
    6,  40,   1,  43,   0,   0,...
    7,  44,   1,  47,   0,   0,...
    8,  48,   1,  51,   0,   0,...
    1,  52,   1,  55,   0,   0,...
    1,  56,   1,  59,   0,   0,...
    1,  60,   1,  63,   0,   0,...
    1,  64,   1,  67,   0,   0,...
    8,  68,   1,  71,   0,   0,...
    6,  72,   1,  75,   0,   0,...
    7,  76,   1,  79,   0,   0,...
    6,  80,   1,  83,   0,   0,...
    6,  84,   1,  87,   0,   0,...
    6,  88,   1,  91,   0,   0,...
    7,  92,   1,  95,   0,   0,...
    8,  96,   1,  99,   0,   0,...
    1, 100,   1, 103,   0,   0,...
    1, 104,   1, 107,   0,   0,...
    1, 108,   1, 111,   0,   0,...
    1, 112,   1, 115,   0,   0];
  bas = [
    0,   0,   8,   2,   0, 130, 138,   0, ...
    0,   0,   1,   1,   0, 154, 155,   0, ...
    0,   0,   1,   1,   0, 156, 157,   0, ...
    0,   1,   3,   1,   0, 158, 161,   0, ...
    0,   1,   1,   1,   0, 164, 165,   0, ...
    0,   1,   1,   1,   0, 166, 167,   0, ...
    0,   2,   1,   1,   0, 168, 169,   0, ...
    0,   2,   1,   1,   0, 170, 171,   0, ...
    1,   0,   8,   2,   0, 214, 222,   0, ...
    1,   0,   1,   1,   0, 238, 239,   0, ...
    1,   0,   1,   1,   0, 240, 241,   0, ...
    1,   1,   3,   1,   0, 242, 245,   0, ...
    1,   1,   1,   1,   0, 248, 249,   0, ...
    1,   1,   1,   1,   0, 250, 251,   0, ...
    1,   2,   1,   1,   0, 252, 253,   0, ...
    1,   2,   1,   1,   0, 254, 255,   0, ...
    2,   0,   8,   2,   0, 172, 180,   0, ...
    2,   0,   1,   1,   0, 196, 197,   0, ...
    2,   0,   1,   1,   0, 198, 199,   0, ...
    2,   1,   3,   1,   0, 200, 203,   0, ...
    2,   1,   1,   1,   0, 206, 207,   0, ...
    2,   1,   1,   1,   0, 208, 209,   0, ...
    2,   2,   1,   1,   0, 210, 211,   0, ...
    2,   2,   1,   1,   0, 212, 213,   0, ...
    3,   0,   8,   2,   0, 214, 222,   0, ...
    3,   0,   1,   1,   0, 238, 239,   0, ...
    3,   0,   1,   1,   0, 240, 241,   0, ...
    3,   1,   3,   1,   0, 242, 245,   0, ...
    3,   1,   1,   1,   0, 248, 249,   0, ...
    3,   1,   1,   1,   0, 250, 251,   0, ...
    3,   2,   1,   1,   0, 252, 253,   0, ...
    3,   2,   1,   1,   0, 254, 255,   0, ...
    4,   0,   8,   2,   0, 214, 222,   0, ...
    4,   0,   1,   1,   0, 238, 239,   0, ...
    4,   0,   1,   1,   0, 240, 241,   0, ...
    4,   1,   3,   1,   0, 242, 245,   0, ...
    4,   1,   1,   1,   0, 248, 249,   0, ...
    4,   1,   1,   1,   0, 250, 251,   0, ...
    4,   2,   1,   1,   0, 252, 253,   0, ...
    4,   2,   1,   1,   0, 254, 255,   0, ...
    5,   0,   8,   2,   0, 214, 222,   0, ...
    5,   0,   1,   1,   0, 238, 239,   0, ...
    5,   0,   1,   1,   0, 240, 241,   0, ...
    5,   1,   3,   1,   0, 242, 245,   0, ...
    5,   1,   1,   1,   0, 248, 249,   0, ...
    5,   1,   1,   1,   0, 250, 251,   0, ...
    5,   2,   1,   1,   0, 252, 253,   0, ...
    5,   2,   1,   1,   0, 254, 255,   0, ...
    6,   0,   8,   2,   0, 172, 180,   0, ...
    6,   0,   1,   1,   0, 196, 197,   0, ...
    6,   0,   1,   1,   0, 198, 199,   0, ...
    6,   1,   3,   1,   0, 200, 203,   0, ...
    6,   1,   1,   1,   0, 206, 207,   0, ...
    6,   1,   1,   1,   0, 208, 209,   0, ...
    6,   2,   1,   1,   0, 210, 211,   0, ...
    6,   2,   1,   1,   0, 212, 213,   0, ...
    7,   0,   8,   2,   0, 130, 138,   0, ...
    7,   0,   1,   1,   0, 154, 155,   0, ...
    7,   0,   1,   1,   0, 156, 157,   0, ...
    7,   1,   3,   1,   0, 158, 161,   0, ...
    7,   1,   1,   1,   0, 164, 165,   0, ...
    7,   1,   1,   1,   0, 166, 167,   0, ...
    7,   2,   1,   1,   0, 168, 169,   0, ...
    7,   2,   1,   1,   0, 170, 171,   0, ...
    8,   0,   3,   1,   0, 116, 119,   0, ...
    8,   0,   1,   1,   0, 122, 123,   0, ...
    8,   0,   1,   1,   0, 124, 125,   0, ...
    8,   1,   1,   1,   0, 126, 127,   0, ...
    8,   1,   1,   1,   0, 128, 129,   0, ...
    9,   0,   3,   1,   0, 116, 119,   0, ...
    9,   0,   1,   1,   0, 122, 123,   0, ...
    9,   0,   1,   1,   0, 124, 125,   0, ...
    9,   1,   1,   1,   0, 126, 127,   0, ...
    9,   1,   1,   1,   0, 128, 129,   0, ...
   10,   0,   3,   1,   0, 116, 119,   0, ...
   10,   0,   1,   1,   0, 122, 123,   0, ...
   10,   0,   1,   1,   0, 124, 125,   0, ...
   10,   1,   1,   1,   0, 126, 127,   0, ...
   10,   1,   1,   1,   0, 128, 129,   0, ...
   11,   0,   3,   1,   0, 116, 119,   0, ...
   11,   0,   1,   1,   0, 122, 123,   0, ...
   11,   0,   1,   1,   0, 124, 125,   0, ...
   11,   1,   1,   1,   0, 126, 127,   0, ...
   11,   1,   1,   1,   0, 128, 129,   0, ...
   12,   0,   8,   2,   0, 130, 138,   0, ...
   12,   0,   1,   1,   0, 154, 155,   0, ...
   12,   0,   1,   1,   0, 156, 157,   0, ...
   12,   1,   3,   1,   0, 158, 161,   0, ...
   12,   1,   1,   1,   0, 164, 165,   0, ...
   12,   1,   1,   1,   0, 166, 167,   0, ...
   12,   2,   1,   1,   0, 168, 169,   0, ...
   12,   2,   1,   1,   0, 170, 171,   0, ...
   13,   0,   8,   2,   0, 214, 222,   0, ...
   13,   0,   1,   1,   0, 238, 239,   0, ...
   13,   0,   1,   1,   0, 240, 241,   0, ...
   13,   1,   3,   1,   0, 242, 245,   0, ...
   13,   1,   1,   1,   0, 248, 249,   0, ...
   13,   1,   1,   1,   0, 250, 251,   0, ...
   13,   2,   1,   1,   0, 252, 253,   0, ...
   13,   2,   1,   1,   0, 254, 255,   0, ...
   14,   0,   8,   2,   0, 172, 180,   0, ...
   14,   0,   1,   1,   0, 196, 197,   0, ...
   14,   0,   1,   1,   0, 198, 199,   0, ...
   14,   1,   3,   1,   0, 200, 203,   0, ...
   14,   1,   1,   1,   0, 206, 207,   0, ...
   14,   1,   1,   1,   0, 208, 209,   0, ...
   14,   2,   1,   1,   0, 210, 211,   0, ...
   14,   2,   1,   1,   0, 212, 213,   0, ...
   15,   0,   8,   2,   0, 214, 222,   0, ...
   15,   0,   1,   1,   0, 238, 239,   0, ...
   15,   0,   1,   1,   0, 240, 241,   0, ...
   15,   1,   3,   1,   0, 242, 245,   0, ...
   15,   1,   1,   1,   0, 248, 249,   0, ...
   15,   1,   1,   1,   0, 250, 251,   0, ...
   15,   2,   1,   1,   0, 252, 253,   0, ...
   15,   2,   1,   1,   0, 254, 255,   0, ...
   16,   0,   8,   2,   0, 214, 222,   0, ...
   16,   0,   1,   1,   0, 238, 239,   0, ...
   16,   0,   1,   1,   0, 240, 241,   0, ...
   16,   1,   3,   1,   0, 242, 245,   0, ...
   16,   1,   1,   1,   0, 248, 249,   0, ...
   16,   1,   1,   1,   0, 250, 251,   0, ...
   16,   2,   1,   1,   0, 252, 253,   0, ...
   16,   2,   1,   1,   0, 254, 255,   0, ...
   17,   0,   8,   2,   0, 214, 222,   0, ...
   17,   0,   1,   1,   0, 238, 239,   0, ...
   17,   0,   1,   1,   0, 240, 241,   0, ...
   17,   1,   3,   1,   0, 242, 245,   0, ...
   17,   1,   1,   1,   0, 248, 249,   0, ...
   17,   1,   1,   1,   0, 250, 251,   0, ...
   17,   2,   1,   1,   0, 252, 253,   0, ...
   17,   2,   1,   1,   0, 254, 255,   0, ...
   18,   0,   8,   2,   0, 172, 180,   0, ...
   18,   0,   1,   1,   0, 196, 197,   0, ...
   18,   0,   1,   1,   0, 198, 199,   0, ...
   18,   1,   3,   1,   0, 200, 203,   0, ...
   18,   1,   1,   1,   0, 206, 207,   0, ...
   18,   1,   1,   1,   0, 208, 209,   0, ...
   18,   2,   1,   1,   0, 210, 211,   0, ...
   18,   2,   1,   1,   0, 212, 213,   0, ...
   19,   0,   8,   2,   0, 130, 138,   0, ...
   19,   0,   1,   1,   0, 154, 155,   0, ...
   19,   0,   1,   1,   0, 156, 157,   0, ...
   19,   1,   3,   1,   0, 158, 161,   0, ...
   19,   1,   1,   1,   0, 164, 165,   0, ...
   19,   1,   1,   1,   0, 166, 167,   0, ...
   19,   2,   1,   1,   0, 168, 169,   0, ...
   19,   2,   1,   1,   0, 170, 171,   0, ...
   20,   0,   3,   1,   0, 116, 119,   0, ...
   20,   0,   1,   1,   0, 122, 123,   0, ...
   20,   0,   1,   1,   0, 124, 125,   0, ...
   20,   1,   1,   1,   0, 126, 127,   0, ...
   20,   1,   1,   1,   0, 128, 129,   0, ...
   21,   0,   3,   1,   0, 116, 119,   0, ...
   21,   0,   1,   1,   0, 122, 123,   0, ...
   21,   0,   1,   1,   0, 124, 125,   0, ...
   21,   1,   1,   1,   0, 126, 127,   0, ...
   21,   1,   1,   1,   0, 128, 129,   0, ...
   22,   0,   3,   1,   0, 116, 119,   0, ...
   22,   0,   1,   1,   0, 122, 123,   0, ...
   22,   0,   1,   1,   0, 124, 125,   0, ...
   22,   1,   1,   1,   0, 126, 127,   0, ...
   22,   1,   1,   1,   0, 128, 129,   0, ...
   23,   0,   3,   1,   0, 116, 119,   0, ...
   23,   0,   1,   1,   0, 122, 123,   0, ...
   23,   0,   1,   1,   0, 124, 125,   0, ...
   23,   1,   1,   1,   0, 126, 127,   0, ...
   23,   1,   1,   1,   0, 128, 129,   0];
  env = [
    0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00, ...
    0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00, ...
    0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00, ...
    0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00, ...
    0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00, ...
   -2.77096513e+00,  1.91272277e+00,  0.00000000e+00,  0.00000000e+00, ...
   -1.18702466e+00,  3.61744187e+00,  0.00000000e+00,  0.00000000e+00, ...
    1.36156525e+00,  3.19036566e+00,  0.00000000e+00,  0.00000000e+00, ...
    3.09296955e+00,  5.11223149e+00,  0.00000000e+00,  0.00000000e+00, ...
    2.41299809e+00,  7.57057601e+00,  0.00000000e+00,  0.00000000e+00, ...
   -2.43019724e-01,  8.24327807e+00,  0.00000000e+00,  0.00000000e+00, ...
   -1.84762870e+00,  6.12203858e+00,  0.00000000e+00,  0.00000000e+00, ...
   -1.12858772e+00,  1.03678059e+01,  0.00000000e+00,  0.00000000e+00, ...
    3.79901167e+00,  9.05909042e+00,  0.00000000e+00,  0.00000000e+00, ...
    1.93366509e+00,  1.33449057e+00,  0.00000000e+00,  0.00000000e+00, ...
   -3.72281111e+00,  6.48626760e+00,  0.00000000e+00,  0.00000000e+00, ...
    5.04379619e+00,  4.51331170e+00,  0.00000000e+00,  0.00000000e+00, ...
    2.77096513e+00, -1.91272277e+00,  0.00000000e+00,  0.00000000e+00, ...
    1.18702466e+00, -3.61744187e+00,  0.00000000e+00,  0.00000000e+00, ...
   -1.36156525e+00, -3.19036566e+00,  0.00000000e+00,  0.00000000e+00, ...
   -3.09296955e+00, -5.11223149e+00,  0.00000000e+00,  0.00000000e+00, ...
   -2.41299809e+00, -7.57057601e+00,  0.00000000e+00,  0.00000000e+00, ...
    2.43019724e-01, -8.24327807e+00,  0.00000000e+00,  0.00000000e+00, ...
    1.84762870e+00, -6.12203858e+00,  0.00000000e+00,  0.00000000e+00, ...
    1.12858772e+00, -1.03678059e+01,  0.00000000e+00,  0.00000000e+00, ...
   -3.79901167e+00, -9.05909042e+00,  0.00000000e+00,  0.00000000e+00, ...
   -1.93366509e+00, -1.33449057e+00,  0.00000000e+00,  0.00000000e+00, ...
    3.72281111e+00, -6.48626760e+00,  0.00000000e+00,  0.00000000e+00, ...
   -5.04379619e+00, -4.51331170e+00,  0.00000000e+00,  0.00000000e+00, ...
    1.30100000e+01,  1.96200000e+00,  4.44600000e-01,  5.79764064e-01, ...
    9.83419580e-01,  1.11930215e+00,  1.22000000e-01,  5.21536727e-01, ...
    2.97400000e-02,  1.80934235e-01,  7.27000000e-01,  1.95840453e+00, ...
    1.41000000e-01,  2.52062526e-01,  1.17200000e+04,  1.75900000e+03, ...
    4.00800000e+02,  1.13700000e+02,  3.70300000e+01,  1.32700000e+01, ...
    5.02500000e+00,  1.01300000e+00,  2.01954000e+00,  3.75176051e+00, ...
    6.29675240e+00,  9.21467523e+00,  1.07298897e+01,  7.87818279e+00, ...
    2.29637501e+00,  3.94147511e-02, -8.94856161e-01, -1.70329657e+00, ...
   -2.78735973e+00, -4.44591655e+00, -5.28622990e+00, -5.71024998e+00, ...
   -1.94898449e+00,  2.79438767e+00,  3.02300000e-01,  1.03001520e+00, ...
    7.89600000e-02,  3.76331333e-01,  1.77000000e+01,  3.85400000e+00, ...
    1.04600000e+00,  6.63856461e+00,  5.25433167e+00,  2.28748174e+00, ...
    2.75300000e-01,  5.81757722e-01,  6.85600000e-02,  1.02346478e-01, ...
    1.18500000e+00,  3.51185438e+00,  3.32000000e-01,  3.78896883e-01, ...
    9.04600000e+03,  1.35700000e+03,  3.09300000e+02,  8.77300000e+01, ...
    2.85600000e+01,  1.02100000e+01,  3.83800000e+00,  7.46600000e-01, ...
    1.63952511e+00,  3.04243049e+00,  5.10397088e+00,  7.47046862e+00, ...
    8.69498936e+00,  6.46916279e+00,  1.92651664e+00,  3.13141682e-02, ...
   -7.14731953e-01, -1.36022624e+00, -2.22569718e+00, -3.54336401e+00, ...
   -4.19727941e+00, -4.54726296e+00, -1.68246433e+00,  2.22075187e+00, ...
    2.24800000e-01,  8.24825833e-01,  6.12400000e-02,  3.11022216e-01, ...
    1.35500000e+01,  2.91700000e+00,  7.97300000e-01,  4.46751132e+00, ...
    3.56393896e+00,  1.65512513e+00,  2.18500000e-01,  4.35811508e-01, ...
    5.61100000e-02,  7.96681493e-02,  8.17000000e-01,  1.83196843e+00, ...
    2.30000000e-01,  1.99321019e-01,  6.66500000e+03,  1.00000000e+03, ...
    2.28000000e+02,  6.47100000e+01,  2.10600000e+01,  7.49500000e+00, ...
    2.79700000e+00,  5.21500000e-01,  1.28887278e+00,  2.39276234e+00, ...
    4.01148824e+00,  5.85976509e+00,  6.81976662e+00,  5.13046805e+00, ...
    1.55679276e+00,  2.35587606e-02, -5.46552977e-01, -1.04144203e+00, ...
   -1.70473124e+00, -2.69921437e+00, -3.19078522e+00, -3.44781747e+00, ...
   -1.39684233e+00,  1.69586408e+00,  1.59600000e-01,  6.37954477e-01, ...
    4.69000000e-02,  2.54621256e-01,  9.43900000e+00,  2.00200000e+00, ...
    5.45600000e-01,  2.75016415e+00,  2.17593660e+00,  1.04017442e+00, ...
    1.51700000e-01,  2.76195354e-01,  4.04100000e-02,  5.28561414e-02, ...
    5.50000000e-01,  9.16566738e-01,  1.51000000e-01,  9.54418928e-02];
  natm = numel(atm)/6;
  nbas = numel(bas)/8;
  nao = ao_loc(shls_slice(2)+1) - ao_loc(shls_slice(1)+1);
  triuidx = 1:Norb^2;
  triflag = true(Norb,Norb);
  triflag = triu(triflag);
  triuidx = triuidx(triflag(:));
end

if 1 % 2025 version
  ngrids = n1*n2*n3;
  xyz = [x(:), y(:), z(:)]';
  xyz = xyz(:);
  fi = zeros([Norb ngrids]); 
  fi = GTOval_uracil_dimer_aug_ccpvdz_mwrap_mex(ngrids, shls_slice, ao_loc, fi, xyz, non0tab, atm, natm, bas, nbas, env);
  fi = reshape(fi,[Norb ngrids]);
  
  if 0 % naive version
    ftmp = zeros([ngrids nd]); % need to be changed later
    for k=1:ngrids
      fij = fi(:,k).*fi(:,k)';
      ftmp(k,:) = fij(triuidx);
    end
    f = reshape(ftmp,[n1 n2 n3 nd]);
  end

  % these will dominate due to ^2 scaling...
  firs = reshape(fi, [Norb, 1, ngrids]);
  fij_full = pagemtimes(firs, permute(firs, [2, 1, 3])); 
  ftmp = reshape(fij_full,[Norb^2 ngrids]);
  ftmp = ftmp(triuidx,:)';
  f = reshape(ftmp,[n1 n2 n3 nd]);
end  
